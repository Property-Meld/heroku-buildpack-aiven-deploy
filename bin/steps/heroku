#!/usr/bin/env bash

source /dev/stdin <<< "$(curl -s --retry 3 https://lang-common.s3.amazonaws.com/buildpack-stdlib/v4/stdlib.sh)"

HEROKU_CLI_URL="https://cli-assets.heroku.com/heroku-linux-x64.tar.xz"

puts_step "Fetching and vendoring Heroku CLI into slug"
rm -rf "$BUILD_DIR/.heroku/cli"
mkdir -p "$BUILD_DIR/.heroku/cli"
mkdir -p "$BUILD_DIR/.heroku/bin"
cd "$BUILD_DIR/.heroku/cli"

curl -s --retry 3 $HEROKU_CLI_URL | tar xJ --strip-components 1
ln -s "../cli/bin/heroku" "$BUILD_DIR/.heroku/bin/heroku"

puts_step "Installing profile.d script"
mkdir -p "$BUILD_DIR/.profile.d"
cat <<EOF > "$BUILD_DIR/.profile.d/heroku-cli.sh"
export PATH="\$PATH:\$HOME/.heroku/bin"
export HEROKU_SKIP_ANALYTICS=1
export HEROKU_DISABLE_AUTOUPDATE=1
EOF
chmod +x "$BUILD_DIR/.profile.d/heroku-cli.sh"

"$BUILD_DIR/.heroku/bin/heroku" version
puts_step "Heroku CLI installation done"

if [ -d "$ENV_DIR" ]; then
  export "HEROKU_API_KEY=$(cat $ENV_DIR/HEROKU_API_KEY)"
  export "HEROKU_APP_NAME=$(cat $ENV_DIR/HEROKU_APP_NAME)"

  echo "AIVEN_PROJECT_NAME ENV_DIR: $(cat $ENV_DIR/AIVEN_PROJECT_NAME)"
  export "AIVEN_AUTH_TOKEN=$(cat $ENV_DIR/AIVEN_AUTH_TOKEN)"
  export "AIVEN_PROJECT_NAME=$(cat $ENV_DIR/AIVEN_PROJECT_NAME)"

  export "IS_REVIEW_APP=$(cat $ENV_DIR/IS_REVIEW_APP)"
  export "STAGING_DATABASE_URL=$(cat $ENV_DIR/STAGING_DATABASE_URL)"
fi

puts_step "install aiven-client"
python -m pip install git+https://github.com/aiven/aiven-client.git
